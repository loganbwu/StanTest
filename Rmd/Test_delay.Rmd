_---
title: "PLAN for Chapter 1. Methodology for fitting ODE epidemic models"
subtitle: "This RMarkdown is a template as initially outlined in the progress report. Each task will be outlined and then followed by a code block to be completed."
output:
html_notebook:
number_sections: true
---

This is to test a model with variable numbers of compartments.

```{r setup}
library(R.utils)
library(tidyverse)
library(rstan)
library(rstansim) # devtools::install_github("ewan-keith/rstansim")
library(parallel)
library(patchwork)
library(pbmcapply)
library(pbapply)
library(RColorBrewer)
source("../R/load_functions.R")
```

```{r}
model_file = "../stan/test_delay_1.stan"
model = stan_model(model_file)

rstan_options(auto_write = TRUE)

n_years = 5
n_iter = 100 # should be at least 500
n_chains = 2
n_repetitions = 1 # how many times to duplicate each scenario
cores_per_sampler = n_chains # 1 for mclapply, or n_chains if not running lots of scenarios
limit_runs = Inf # set to a finite number for testing, or Inf to run all
timelimit_per_run = 60*60 * 5
n_traces = 200 # limit for plotting sample trajectories

n_times = 100
n_delays = 4
data = list(
  `T` = n_times,
  t0 = 0,
  ts = 1:n_times,
  n_delays = n_delays,
  cases = rep(5, n_times),
  y0 = c(1, rep(0, n_delays)),
  dummy = 10
)

true_params = list(
  sigma = 1,
  alpha = 0.1
)

sim_list = my_simulate_data_1(
  file = model_file,
  data_name = "test",
  input_data = data,
  vars = "all",
  param_values = true_params
)

y = sim_list$y %>%
  as_tibble()

y %>%
  mutate(t = sim_list$ts) %>%
  pivot_longer(-t) %>%
  ggplot(aes(x = t, y = value, color= name)) +
  geom_line()

# fit = sampling(
#   model,
#   data = data
# )
```

```{r}
model_file = "../stan/test_delay_2.stan"
model = stan_model(model_file)

n_times = 100
ts = 1:n_times
cases = rpois(n_times, 100)


n_dormant = 1
y0 = rep(0, 2 + 3*(n_dormant+1) + 3)
y0[1] = 0.95
y0[2] = 1 - y0[1]
names(y0) = c("S0", "I0", paste0("Sl", seq_len(n_dormant+1)), paste0("Scl", seq_len(n_dormant+1)), paste0("Icl", seq_len(n_dormant+1)), "ShortIncubations", "LongIncubations", "TrueRelapses")

data = list(
  n_times = n_times,
  t0 = 0,
  ts = ts,
  cases = cases,
  alpha = 0.5,
  beta = 0.5,
  relapse_clinical_immunity = 0,
  gamma_d = 0.1,
  gamma_l = 0.1,
  delta = 0,
  phi = 0,
  f = 0,
  r = 0,
  p_long = 0,
  p_silent = 0,
  population_size = 1,

  n_dormant = n_dormant,
  
  y0 = y0,
  run_estimation = 0
)

true_params = list(
  lambda = 0.0
)

# sim_list = my_simulate_data_1(
#   file = model_file,
#   data_name = "test",
#   input_data = data,
#   vars = "all",
#   param_values = true_params
# )

sim_out = sampling(model,
                   data = data,
                   chains = 1,
                   iter = 100)

sim_summary = with(data, cbind(as.data.frame(
  summary(
    sim_out,
    pars = "y",
    probs = c(0.05, 0.5, 0.95)
  )$summary))) %>%
  rownames_to_column(var = "name") %>%
  mutate(index_i = name %>% str_extract("(?<=\\[)[0-9]+") %>% as.numeric(),
         time = data$ts[index_i],
         index_j = name %>% str_extract("(?<=,)[0-9]+") %>% as.numeric(),
         compartment = names(y0)[index_j],
         variable = name %>% str_remove("\\[.*")) %>%
  as_tibble() %>%
  group_by(time) %>%
  mutate(Total = sum(mean))

sim_summary %>%
  filter(!compartment %in% c("ShortIncubations", "LongIncubations", "TrueRelapses")) %>%
  drop_na(compartment) %>%
  ggplot(aes(x = time, y = mean, color = compartment)) +
  geom_line() +
  geom_line(aes(y=Total, color=NULL))
```