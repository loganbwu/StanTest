---
title: "Eight Schools"
output: html_notebook
---

```{r setup}
library(outbreaks)
library(rstan)
library(tidyverse)
options(mc.cores = 8)
rstan_options(auto_write = TRUE)
```

```{r}
# time series of cases
cases <- influenza_england_1978_school$in_bed  # Number of students in bed
cases = rep(10, 12)
N = 100;

# times
n_times = length(cases)
month = 365.25/n_times
t <- seq(month, month*n_times, length.out = n_times)
t0 = 0

#initial conditions
I_init = 0.1
y0 = c(Il=0, I0=I_init, Sl=0, S0=1-I_init)

# data for Stan
data_sis <- list(n_times = n_times, y0 = y0, t0 = t0, ts = t, N = N, cases = cases)

# number of MCMC steps
niter <- 10 # 2000

model <- stan_model("champagne2022.stan")
```

```{r}
fit_sis_negbin <- sampling(model,
                           data = data_sis,
                           iter = niter,
                           chains = 4, 
                           seed = 0)
```

```{r}
pars=c("lambda")
print(fit_sis_negbin, pars = pars)
stan_dens(fit_sis_negbin, pars = pars, separate_chains = TRUE)
smr_pred <- cbind(as.data.frame(summary(
  fit_sis_negbin, pars = "pred_cases", probs = c(0.05, 0.5, 0.95))$summary),
  t=t[1:(n_times-1)], cases=cases[1:(n_times-1)])
colnames(smr_pred) <- make.names(colnames(smr_pred)) # to remove % in the col names

c_posterior = "blue"
ggplot(smr_pred, mapping = aes(x = t)) +
  geom_ribbon(aes(ymin = X5., ymax = X95.), fill = c_posterior, alpha = 0.35) +
  geom_line(mapping = aes(x = t, y = X50.), color = c_posterior) + 
  geom_point(mapping = aes(y = cases)) +
  labs(x = "Day", y = "Cases")

params <- lapply(seq_along(t), function(i){sprintf("y[%s,2]", i)}) #number of infected for each day
smr_y <- as.data.frame(summary(fit_sis_negbin, 
                               pars = params, probs = c(0.05, 0.5, 0.95))$summary)
colnames(smr_y) <- make.names(colnames(smr_y)) # to remove % in the col names

ggplot(smr_y, mapping = aes(x = t)) +
  geom_ribbon(aes(ymin = X5.*N, ymax = X95.*N), fill = c_posterior, alpha = 0.35) +
  geom_line(mapping = aes(x = t, y = X50.*N), color = c_posterior) + 
  labs(x = "Day", y = "Number of infected students")
```