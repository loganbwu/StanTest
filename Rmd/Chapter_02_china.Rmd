_---
title: "PLAN for Chapter 2. Simulation-estimation study for the temperate model"
subtitle: "This RMarkdown is a template as initially outlined in the progress report. Each task will be outlined and then followed by a code block to be completed."
output:
html_notebook:
number_sections: true
---



```{r setup}
library(R.utils)
library(tidyverse)
library(rstan)
library(rstansim) # devtools::install_github("ewan-keith/rstansim")
library(parallel)
library(patchwork)
library(pbmcapply)
library(pbapply)
library(memoise)
library(RColorBrewer)
source("../R/constants.R")
source("../R/load_functions.R")

n_cores = parallelly::availableCores()
# n_cores = 9
options(mc.cores = n_cores)
message("Running on ", n_cores, " cores")
rstan_options(auto_write = TRUE)

n_years = 5
n_iter = 100 # should be at least 500
n_chains = 4
n_repetitions = 1 # how many times to duplicate each scenario
limit_runs = Inf # set to a finite number for testing, or Inf to run all
timelimit_per_run = 60*60 * 5
n_traces = 200 # limit for plotting sample trajectories


# Compile model before we reach any sampling
model_file = "../stan/temperate_9.stan"
model = stan_model(model_file)
my_state_init = state_init_2
my_extract_summary = extract_summary_2
```
## Parameter recovery on real data

We test whether parameter recovery works on real datasets. We will find data from a variety of settings (e.g., transmission levels, remoteness, strains) to demonstrate generalisability.

Data:

- Hainan data (tropical China) but this has been difficult to acquire.
We will not be investigating Chinese Yunnan (southern mountainous) or Henan (central temperate) data which we do have because the Yunnan strain is not known to be tropical, and the Henan data is temperate (our current temperate model does not align with this data convincingly).
- Brazilian 'integrated data set', available per county or municipality and very detailed.

```{r}
china_selections = tribble(
  ~Region, ~min, ~max,
  "Dengzhou", "2004-01-01", "2009-01-01",
  "Guantang", "1977-01-01", "1982-01-01",
  "Huangchuan", NA, NA,
  "Xiayi", NA, NA
) %>%
  mutate(min = as.Date(min),
         max = as.Date(max))

library(MalariaData)
regions = c("Xiayi", "Guantang", "Dengzhou", "Huangchuan") %>% setNames({.})
china_data_all = lapply(regions, function(x) {load_region(x, species = "Vivax", source="Local")}) %>%
  bind_rows(.id = "Region") %>%
  select(Region, Date, Cases) %>%
  left_join(china_selections, by="Region") %>%
  mutate(Date = as.Date(paste(year(Date), month(Date), "01", sep="-")) + months(1) - days(1)) %>% # Align to last day of the month
  mutate(include = ifelse(Date >= min & Date < max, "grey20", "grey"),
         include = replace_na(include, "grey"))

china_data = china_data_all %>%
  filter(include == "grey20") %>%
  select(-include)

ggplot(china_data_all) +
  geom_rect(data=china_selections, aes(xmin=min, xmax=max, ymin=1, ymax=Inf, x=NULL, y=NULL), alpha=0.4, fill="tomato") +
  geom_col(aes(x=Date, y=Cases, fill=include)) +
  facet_wrap(vars(Region), ncol=1, scales="free_y") +
  scale_x_date(breaks = seq(as.Date("1900-01-01"), as.Date("2025-01-01"), by="2 years"), date_labels = "%Y", limits=c(NA_Date_, as.Date("2009-12-31"))) +
  scale_y_log10() +
  scale_fill_identity() +
  labs(title = "Selected monthly P. vivax cases infected in central China",
       x = "Notification date",
       y = "Cases")

ggsave("../plots/china_selected.png", width=8, height=4)
```

```{r}
source("../R/functions/decompose_data.R")
china_decomp = lapply(unique(china_data$Region) %>% setNames({.}), function(x) {
  china_data %>%
    filter(Region == x) %>%
    mutate(logCases = log(Cases+1)) %>%
    decompose_data()
}) %>%
  bind_rows(.id = "Region")

china_decomp %>%
  filter(name %in% c("Cases", "trend", "seasonal", "remainder")) %>%
  mutate(name = name %>% str_to_title()) %>%
  ggplot(aes(x = Date, y = value, color = name)) +
  geom_line() +
  scale_x_date(date_breaks = "years", date_labels = "%Y") +
  facet_grid(rows=vars(name), cols=vars(Region), scales="free")

ggsave("../plots/china_decomp.png", width=8, height=4)
```

Now we fit the model for Dengzhou

```{r}
ts_dengzhou = china_data %>%
  filter(Region == "Dengzhou")
first_year = min(year(ts_dengzhou$Date))
ts_dengzhou = ts_dengzhou %>%
  mutate(ts = as.numeric(Date - as.Date(paste0(first_year, "-01-01"))))
data_dengzhou = list(
  t0 = -30*years,
  n_times = nrow(ts_dengzhou),
  ts = ts_dengzhou$ts,
  cases = ts_dengzhou$Cases,
  alpha = 0.5,
  beta = 0.5,
  relapse_clinical_immunity = 0.9,
  gamma_d = 1/434.,
  gamma_l = 1/223,
  delta = 1/162,
  phi = 0,
  f = 1/72,
  r = 1/60,
  p_long = 1,
  p_silent = 0,
  N = 10000,
  population_size = 10000,
  n_dormant = 4,
  # eps = 0,
  # kappa = 3,
  # phase = 120
)
data_dengzhou$y0 = my_state_init(data_dengzhou, I0=0.01)

tictoc::tic()
samp = sampling(model,
                data = data_dengzhou,
                iter = 100,
                chains = n_chains,
                # init = rep(list(.theta_init), n_chains), # Start from MLE solution
                cores = n_chains,
                pars = "y_extended",
                include = FALSE)
tictoc::toc()
```

```{r}
# inspect parameter posteriors
parameters = c("lambda", "phi_inv", "eps", "kappa", "phase", "relapse_clinical_immunity")
posterior_seasonal = rstan::extract(samp, parameters[parameters %in% names(samp)]) %>%
  as_tibble() %>%
  mutate(phi = 1/phi_inv) %>%
  select(-phi_inv) %>%
  pivot_longer(everything(), names_to = "parameter", values_to = "value")

posterior_seasonal %>%
  ggplot(aes(x = value, fill=parameter, color=parameter)) +
  geom_density(alpha=0.5) +
  scale_fill_manual(values = param_colors, drop=F) +
  scale_color_manual(values = param_colors, drop=F) +
  coord_cartesian(xlim = c(0, NA)) +
  facet_wrap(vars(parameter), scales="free", labeller=plot_labeller_novar) +
  labs(subtitle = "Parameter estimates")

# ggsave("plots/rondonia_seasonal_posterior.png", width=8, height=4)

# Plot credible intervals
n_traces = 100
incidence = rstan::extract(samp, "incidence")[[1]]
sample_ix = sample(seq_len(dim(incidence)[1]), n_traces, replace=T)
incidence_sample_nonseasonal = as_tibble(t(incidence[sample_ix,])) %>%
  mutate(j = row_number()) %>%
  pivot_longer(-j, names_to = "trace", values_to = "incidence") %>%
  drop_na(j) %>%
  group_by(j) %>%
  mutate(ts = data_dengzhou$ts[j],
         lower = quantile(incidence, 0.025, na.rm=T),
         upper = quantile(incidence, 0.975, na.rm=T),
         legend = "95% prediction interval")


ggplot(mapping = aes(x=ts/years)) +
  geom_ribbon(data = incidence_sample_nonseasonal,
              aes(ymin=lower, ymax=upper, fill="95% mean incidence interval"),
              alpha = 0.5) +
  geom_point(data = tibble(ts = data_dengzhou$ts, cases = data_dengzhou$cases),
             aes(y = cases, group = NULL, color="Incidence data")) +
  coord_cartesian(ylim = c(0, NA)) +
  scale_fill_manual("", 
                    breaks = c("95% case prediction interval", "95% mean incidence interval", "Incidence data"),
                    values = c("steelblue", "tomato", "black")) +
  scale_colour_manual("", 
                      breaks = c("95% case prediction interval", "95% mean incidence interval", "Incidence data"),
                      values = c("steelblue", "tomato", "black")) +
  labs(subtitle = "Seasonal model, monthly synthetic data",
       x = "Year",
       y = "Annual incidence")
```

End of script.

```{r}
print("Done.")
```

